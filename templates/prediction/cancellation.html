{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Header -->
<div class="header text-center py-3 position-relative" style="background-color: #f0f0f0;">
    <!-- ì´ì „ í˜ì´ì§€ ë²„íŠ¼ì„ ì™¼ìª½ì— ê³ ì • -->
    <a href="/" class="btn btn-secondary position-absolute"
       style="left: 3%; top: 50%; transform: translateY(-50%);">ë©”ì¸ í˜ì´ì§€</a>
    <!-- ì¤‘ì•™ ì •ë ¬ëœ ì œëª©ê³¼ ì„¤ëª… -->
    <div class="d-flex flex-column align-items-center justify-content-center">
        <a href="/" class="text-decoration-none">
            <h1 class="fw-bold text-primary">Life Is Travel</h1>
        </a>
        <p class="text-center text-muted">ì˜¤ëŠ˜ ë‚´ í•­ê³µí¸ ì§€ì—°ë ê¹Œ?</p>
    </div>
</div>
<div class="container mt-5">
    <!-- Form Section -->
    <div id="form-container" class="card p-4 shadow-sm mx-auto" style="max-width: 500px;">
        <form onsubmit="handleSubmit(event)">
            <!-- ì¶œë°œì¼ì -->
            <div class="mb-3">
                <label for="departure-date" class="form-label">ì¶œë°œì¼ì:</label>
                <input type="date" id="departure-date" name="departure-date" class="form-control" required>
            </div>
            <!-- í•­ê³µì‚¬ -->
            <div class="mb-3">
                <label for="airline" class="form-label">í•­ê³µì‚¬:</label>
                <input type="text" id="airline" name="airline" class="form-control" placeholder="ì˜ˆ: ëŒ€í•œí•­ê³µ" required>
            </div>
            <!-- ì¶œë°œê³µí•­ -->
            <div class="mb-3">
                <label for="departure-airport" class="form-label">ì¶œë°œê³µí•­:</label>
                <input type="text" id="departure-airport" name="departure-airport" class="form-control" placeholder="ì˜ˆ: ICN" required>
            </div>
            <!-- ë„ì°©ê³µí•­ -->
            <div class="mb-3">
                <label for="arrival-airport" class="form-label">ë„ì°©ê³µí•­:</label>
                <input type="text" id="arrival-airport" name="arrival-airport" class="form-control" placeholder="ì˜ˆ: NRT" required>
            </div>
            <!-- ì¶œë°œì‹œê°„ -->
            <div class="mb-3">
                <label for="departure-time" class="form-label">ì¶œë°œì‹œê°„:</label>
                <input type="time" id="departure-time" name="departure-time" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">ê²°ê³¼ í™•ì¸</button>
        </form>
    </div>

    <!-- Result Section -->
    <div id="result-container" class="d-none text-center mt-4">
        <div class="alert alert-info" id="result-message">
            <!-- ì§€ì—° í™•ë¥  ë° ë©˜íŠ¸ê°€ ì—¬ê¸°ì— ì¶œë ¥ë©ë‹ˆë‹¤ -->
        </div>
         <!-- ë„ì°©ì§€ì˜ ë‚ ì”¨ ì •ë³´ ì„¹ì…˜ -->
        <div class="card bg-light p-4 mt-3">
            <h5 class="text-secondary">ë„ì°©ì§€ì˜ ë‚ ì”¨ ì •ë³´</h5>
            <button id="weather-button" class="btn btn-info w-100 mt-2">ë„ì°©ì§€ ë‚ ì”¨ ì •ë³´ í™•ì¸</button>

            <!-- ë‚ ì”¨ ì •ë³´ê°€ í‘œì‹œë  ì˜ì—­ -->
            <div id="weather-info" class="mt-3"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ê³µí•­ ì½”ë“œë³„ ìœ„ë„, ê²½ë„ ë§¤í•‘
    const airportCoords = {
        "ICN": { lat: 37.4602, lon: 126.4407 },  // ì¸ì²œ
        "CTS": { lat: 42.7752, lon: 141.6923 },  // ì‹ ì¹˜í† ì„¸
        "NRT": { lat: 35.7720, lon: 140.3929 },  // ë‚˜ë¦¬íƒ€
        "KIX": { lat: 34.4342, lon: 135.2440 },  // ê°„ì‚¬ì´
        "FUK": { lat: 33.5859, lon: 130.4507 }   // í›„ì¿ ì˜¤ì¹´
    };

    // ìœ íš¨í•œ ê³µí•­ ì½”ë“œ ë¦¬ìŠ¤íŠ¸
    const validAirports = Object.keys(airportCoords);

    // OpenWeather API í‚¤
    const apiKey = "d58c07bb7016f7eb86be1861b09d804d";

    // í•­ê³µí¸ ê²€ìƒ‰ í¼ ì œì¶œ ì²˜ë¦¬
    function handleSubmit(event) {
        event.preventDefault();  // í¼ ì œì¶œ ê¸°ë³¸ ë™ì‘ ë°©ì§€

        // ì…ë ¥ê°’ ê°€ì ¸ì˜¤ê¸°
        const date = document.getElementById("departure-date").value;
        const airline = document.getElementById("airline").value;
        const departureAirport = document.getElementById("departure-airport").value.toUpperCase();
        const arrivalAirport = document.getElementById("arrival-airport").value.toUpperCase();
        const scheduledTime = document.getElementById("departure-time").value;

        // ì¶œë°œ/ë„ì°© ê³µí•­ ìœ íš¨ì„± ê²€ì‚¬
        if (!validAirports.includes(departureAirport) || !validAirports.includes(arrivalAirport)) {
            alert("ì§€ì›í•˜ëŠ” ê³µí•­ì€ ICN, CTS, NRT, KIX, FUK ì…ë‹ˆë‹¤.");
            return;
        }

        // ë‚ ì§œ ì œí•œ ê²€ì‚¬ (+16ì¼)
        const selectedDate = new Date(date);
        const today = new Date();
        const maxDate = new Date();
        maxDate.setDate(today.getDate() + 16);

        if (selectedDate > maxDate) {
            alert("í•­ê³µí¸ ê²€ìƒ‰ì€ ì¶œë°œì¼ ê¸°ì¤€ ìµœëŒ€ 16ì¼ê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
        }

        // API ìš”ì²­ ë°ì´í„° êµ¬ì„±
        const requestData = {
            date: date,
            scheduled_time: scheduledTime,
            departure_airport: departureAirport,
            arrival_airport: arrivalAirport,
            airline: airline
        };

        // í•­ê³µí¸ ì§€ì—° ì˜ˆì¸¡ API í˜¸ì¶œ
        fetch("http://43.202.202.181:8000/predict/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(requestData)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const probability = data.probability;
            const message = getMessage(probability);

            document.getElementById("form-container").classList.add("mb-4");
            document.getElementById("result-container").classList.remove("d-none");
            document.getElementById("result-message").innerHTML =
                `ì˜¤ëŠ˜ í•­ê³µí¸ì´ ì§€ì—°ë  í™•ë¥ ì€ <strong>${probability}%</strong> ì…ë‹ˆë‹¤.<br>${message}`;
        })
        .catch(error => {
            console.error("API í˜¸ì¶œ ì˜¤ë¥˜:", error);
            document.getElementById("result-message").innerHTML =
                `<span class="text-danger">ì˜ˆì¸¡ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</span>`;
            document.getElementById("result-container").classList.remove("d-none");
        });
    }

    // í™•ë¥ ì— ë”°ë¥¸ ë©”ì‹œì§€ ë°˜í™˜
    function getMessage(probability) {
        if (probability < 20) {
            return "ì•ˆì „í•œ ì—¬í–‰ ë˜ì„¸ìš”!";
        } else if (probability < 50) {
            return "ì ì‹œ ê¸´ì¥ì„ í•´ì£¼ì„¸ìš”.";
        } else {
            return "ì§€ì—°ë  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì¤€ë¹„ë¥¼ ê³ ë ¤í•˜ì„¸ìš”.";
        }
    }

    // ë‚ ì”¨ ì •ë³´ ì¡°íšŒ í•¨ìˆ˜
    function fetchWeatherInfo(airportCode, date, time) {
        const coords = airportCoords[airportCode.toUpperCase()];
        if (!coords) {
            alert("ì§€ì›í•˜ì§€ ì•ŠëŠ” ê³µí•­ì…ë‹ˆë‹¤.");
            return;
        }

        const timestamp = Math.floor(new Date(`${date}T${time}`).getTime() / 1000);
        const url = `https://api.openweathermap.org/data/3.0/onecall/timemachine?lat=${coords.lat}&lon=${coords.lon}&dt=${timestamp}&appid=${apiKey}&units=metric`;

        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error("ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                return response.json();
            })
            .then(data => {
                displayWeatherInfo(data);
            })
            .catch(error => {
                console.error("ë‚ ì”¨ ì •ë³´ ì˜¤ë¥˜:", error);
                document.getElementById("weather-info").innerHTML =
                    `<span class="text-danger">ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</span>`;
            });
    }

    // ë‚ ì”¨ ì •ë³´ ë Œë”ë§ í•¨ìˆ˜
    function displayWeatherInfo(data) {
        const weather = data.data[0].weather[0];
        const temp = data.data[0].temp;
        const humidity = data.data[0].humidity;
        const windSpeed = data.data[0].wind_speed;

        const weatherHTML = `
            <div class="card shadow-lg p-4 border-0" style="background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%); color: white;">
                <div class="d-flex align-items-center">
                    <img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png" alt="ë‚ ì”¨ ì•„ì´ì½˜" class="me-3">
                    <div>
                        <h4 class="fw-bold mb-1">${weather.main}</h4>
                        <p class="mb-0">${weather.description}</p>
                    </div>
                </div>
                <hr class="my-3" style="border-color: rgba(255, 255, 255, 0.5);">
                <div class="d-flex justify-content-around">
                    <div>
                        <h5>ğŸŒ¡ï¸ ê¸°ì˜¨</h5>
                        <p class="fw-bold mb-0">${temp} Â°C</p>
                    </div>
                    <div>
                        <h5>ğŸ’§ ìŠµë„</h5>
                        <p class="fw-bold mb-0">${humidity}%</p>
                    </div>
                    <div>
                        <h5>ğŸŒ¬ï¸ í’ì†</h5>
                        <p class="fw-bold mb-0">${windSpeed} m/s</p>
                    </div>
                </div>
            </div>
        `;

        document.getElementById("weather-info").innerHTML = weatherHTML;
    }

    // ë‚ ì”¨ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById("weather-button").addEventListener("click", function () {
        const date = document.getElementById("departure-date").value;
        const time = document.getElementById("departure-time").value;
        const arrivalAirport = document.getElementById("arrival-airport").value.toUpperCase();

        if (date && time && arrivalAirport) {
            fetchWeatherInfo(arrivalAirport, date, time);
        } else {
            alert("ì¶œë°œì¼ì, ì‹œê°„, ë„ì°©ê³µí•­ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
        }
    });
</script>
{% endblock %}
