<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Is Travel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        .header {
            background-color: lightgray;
            height: 16.66%;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            display: flex;
            height: 83.34%;
        }
        .left, .right {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .budget {
            margin-top: 2%;
        }
        .search-btn {
            position: absolute;
            bottom: 8%;
            left: 50%;
            transform: translateX(-50%);
        }
        .map-box {
            width: 500px;
            height: 500px;
        }
        .undecided-destination {
            margin-top: 3%;
            text-align: center;
        }
        .departure {
            margin-top: 11%;
            text-align: center;
        }
        .arrival {
            margin-top: 20%;
            text-align: center;
        }
        .undecided-schedule {
            margin-top: 24%;
            text-align: center;
        }
        .date-picker {
            margin-top: 1%;
            width: 230px;
            height: 40px;
            text-align: center;
            font-size: 16px;
            padding: 5px;
            border: 1px solid gray;
            border-radius: 4px;
        }
        .toggle-box {
            display: none;
        }
        .toggle-box select {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="page1.html" style="position: absolute; left: 3%; width: 50px; height: 50px; background-color: gray;"></a>
        여행은 가고 싶은데, 어떻게 할 지 모르겠어. 도와줘!
    </div>
    <form id="travel-form">
        <div class="container">
            <div class="left">
                <div class="budget">
                    예산: <input type="text" name="budget"> 원
                </div>
                <div style="margin-top: 5%;">지도</div>
                <div class="map-box" id="map"></div>
                <div class="undecided-destination">
                    <label>
                        <input type="checkbox" id="undecided-destination-checkbox" name="undecided-map" value="true">
                        아직 여행지를 안 정했어요
                    </label>
                </div>
            </div>
            <div class="right">
                <div class="departure">
                    출발일 (범위)
                </div>
                <input type="text" id="departure-range" class="date-picker" name="departure-range" placeholder="출발일 선택">
                <div class="arrival">
                    도착일 (범위)
                </div>
                <input type="text" id="arrival-range" class="date-picker" name="arrival-range" placeholder="도착일 선택">
                <div class="undecided-schedule">
                    <label>
                        <input type="checkbox" id="undecided-schedule-checkbox" name="undecided-schedule" value="true">
                        아직 일정을 안 정했어요
                    </label>
                    <div class="toggle-box" id="toggle-box" style="display: none;">
                        <label for="stay-duration">숙박 일수:</label>
                        <select name="stay-duration" id="stay-duration">
                            <option value="">선택</option>
                            <option value="1">1박</option>
                            <option value="2">2박</option>
                            <option value="3">3박</option>
                            <option value="4">4박</option>
                            <option value="5">5박</option>
                            <option value="6">6박</option>
                            <option value="7">7박</option>
                            <option value="8">8박</option>
                            <option value="9">9박</option>
                            <option value="10">10박</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="search-btn">
            <button type="submit">검색</button>
        </div>
    </form>
    
    <script src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBnNhOJJoB4bLJXpYQuFOIClstU6yTbUDE"></script>
    <script>

        let selectedCities = [];  // 선택된 도시들을 저장할 배열

        function initMap() {
            const japan = { lat: 36.2048, lng: 138.2529 }; // 일본 중심 좌표
            const map = new google.maps.Map(document.getElementById('map'), {
                zoom: 5,
                center: japan,
                streetViewControl: false,  // 로드뷰 아이콘을 없앰
                mapTypeControl: false // 지도/위성 옵션 제거
            });
        
            // 도시 데이터 정의
            const cities = [
                { name: '후쿠오카', lat: 33.5902, lng: 130.4017 },
                { name: '삿포로', lat: 43.0618, lng: 141.3545 },
                { name: '도쿄', lat: 35.6895, lng: 139.6917 },
                { name: '오사카', lat: 34.6937, lng: 135.5023 }
            ];
        
            let selectedMarkers = [];  // 선택된 마커들을 관리하는 배열
            let currentInfoWindow = null;  // 현재 열려있는 InfoWindow를 추적하는 변수
        
            cities.forEach(city => {
                const marker = new google.maps.Marker({
                    position: { lat: city.lat, lng: city.lng },
                    map: map,
                    title: city.name,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png',  // 기본 아이콘 (빨간색)
                });
        
                const infoWindow = new google.maps.InfoWindow({
                    content: `<div style="background-color: white; text-align: center;">
                                <strong>${city.name}</strong>
                              </div>`,
                });
        
                marker.addListener('click', () => {
                    // 기존에 열려 있는 InfoWindow가 있으면 닫기
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                    }
        
                    // 마커를 클릭하면 해당 마커의 InfoWindow 열기
                    infoWindow.open(map, marker);
        
                    // 현재 열려있는 InfoWindow를 업데이트
                    currentInfoWindow = infoWindow;
        
                    // 이미 클릭된 마커라면 아이콘을 원래대로 돌려놓기
                    if (marker.getIcon() === 'http://maps.google.com/mapfiles/ms/icons/green-dot.png') {
                        marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');  // 원래 빨간색 아이콘
                        selectedCities.splice(cityIndex, 1);  // 도시 제거
                    } else {
                        // 마커 아이콘을 클릭한 상태로 변경
                        marker.setIcon('http://maps.google.com/mapfiles/ms/icons/green-dot.png');  // 클릭된 마커는 녹색
                        selectedCities.push(city.name);  // 도시 추가
                    }
                });
            });
        }
        

        $(document).ready(function() {
            initMap();

            let departureDateRange = '';
            let arrivalDateRange = '';

            $('#departure-range').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD',
                    separator: " ~ "
                },
                opens: 'center'
            }).on('apply.daterangepicker', function(ev, picker) {
                departureDateRange = picker.startDate.format('YYYY-MM-DD') + '~' + picker.endDate.format('YYYY-MM-DD');
            });;

            $('#arrival-range').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD',
                    separator: " ~ "
                },
                opens: 'center'
            }).on('apply.daterangepicker', function(ev, picker) {
                arrivalDateRange = picker.startDate.format('YYYY-MM-DD') + '~' + picker.endDate.format('YYYY-MM-DD');
            });;

            $('#undecided-schedule-checkbox').on('change', function() {
                const toggleBox = document.getElementById('toggle-box');
                toggleBox.style.display = this.checked ? 'block' : 'none';
            });

            $('#travel-form').on('submit', function(event) {
                event.preventDefault();
                const destinationChecked = $('#undecided-destination-checkbox').is(':checked');
                const scheduleChecked = $('#undecided-schedule-checkbox').is(':checked');

                console.log("Form submitted!");

                // 두 개의 체크박스가 모두 선택된 경우
                if (destinationChecked && scheduleChecked) {
                    alert("최대 하나만 선택할 수 있습니다. 하나의 체크박스만 선택해주세요.");
                    
                    // 선택 상태를 취소하고, 이전 상태로 돌아가도록 설정
                    $('#undecided-destination-checkbox').prop('checked', false);
                    $('#undecided-schedule-checkbox').prop('checked', false);
                    
                    // 토글박스 숨기기 (일정 체크박스를 해제하면 토글박스를 숨김)
                    $('#toggle-box').hide();
                    // 체크박스 상태를 다시 확인 (필요에 따라 추가로 상태를 설정할 수 있음)
                    return;  // 함수 종료, 이후 코드 실행을 막습니다.
                }

                // 예산 값을 가져옴
                const budget = $('input[name="budget"]').val();

                // 예산이 비어있으면 알람 띄우고 반환
                if (!budget) {
                    alert("예산을 입력해주세요.");
                    return;  // 이후 코드 실행을 막고 돌아가기
                }

                if (!destinationChecked && !scheduleChecked) {
                    // 도시, 출발일, 도착일 체크
                    if (selectedCities.length === 0 || !departureDateRange || !arrivalDateRange) {
                        // 하나라도 비어있으면 알람 띄우기
                        alert("도시, 출발일(범위), 도착일(범위) 모두 선택해주세요.");
                        return;  // 이후 코드 실행을 막고 돌아가기
                    }
                    // 선택된 도시, 일정들을 URL 파라미터로 전달
                    const citiesParam = encodeURIComponent(selectedCities.join(','));  // 도시 배열을 콤마로 구분된 문자열로 변환
                    const url = `page6.html?cities=${citiesParam}&departure=${encodeURIComponent(departureDateRange)}&arrival=${encodeURIComponent(arrivalDateRange)}&budget=${encodeURIComponent(budget)}`;
                    console.log("Redirecting to:", url);  // URL 확인
                    window.location.href = url;
                } else if (destinationChecked) {
                    // 도시
                    if (!departureDateRange || !arrivalDateRange) {
                        // 일정 비어있으면 알람 띄우기
                        alert("출발일(범위) 혹은 도착일(범위)를 선택해주세요.");
                        return;  // 이후 코드 실행을 막고 돌아가기
                    }
                    // 일정 정보만 넘기기 위해 departure 및 arrival 범위만 URL 파라미터로 전달
                    const url = `page8.html?departure=${encodeURIComponent(departureDateRange)}&arrival=${encodeURIComponent(arrivalDateRange)}&budget=${encodeURIComponent(budget)}`;
                    console.log("Redirecting to:", url);  // URL 확인
                    window.location.href = url;
                } else if (scheduleChecked) {
                    // 도시
                    if (selectedCities.length === 0) {
                        // 도시 비어있으면 알람 띄우기
                        alert("도시를 선택해주세요.");
                        return;  // 이후 코드 실행을 막고 돌아가기
                    }
                    // 숙박 일수 체크
                    const stayDuration = $('#stay-duration').val();  // stay-duration 값을 가져옴
                    if (!stayDuration) {
                        // 숙박 일수가 선택되지 않았으면 알람 띄우기
                        alert("숙박 일수를 선택해주세요.");
                        return;  // 이후 코드 실행을 막고 돌아가기
                    }

                    // 도시 정보만 넘기기 위해 selectedCities 배열을 URL 파라미터로 전달
                    const citiesParam = encodeURIComponent(selectedCities.join(','));  // 도시 배열을 콤마로 구분된 문자열로 변환
                    const url = `page7.html?cities=${citiesParam}&stay-duration=${stayDuration}&budget=${encodeURIComponent(budget)}`;  // 숙박 일수도 파라미터로 전달
                    console.log("Redirecting to:", url);  // URL 확인
                    window.location.href = url;
                }

            });
        });
    </script>
</body>
</html>
